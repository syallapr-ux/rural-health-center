<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Emergency Ambulance Dispatch | Rural Health Connect</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<link rel="stylesheet" href="style.css">

<style>
.status-box {
    border-left: 6px solid #0d6efd;
    background: #f8f9fa;
    padding: 1.2rem;
    border-radius: 8px;
}
.status-idle { border-color: #6c757d; }
.status-accepted { border-color: #ffc107; }
.status-dispatched { border-color: #0dcaf0; }
.status-enroute { border-color: #0d6efd; }
.status-arrived { border-color: #198754; }
.readonly {
    background: #e9ecef;
}
</style>
</head>

<body class="bg-light">

<!-- NAVBAR -->
<nav class="navbar navbar-dark bg-danger shadow">
  <div class="container">
    <a class="navbar-brand fw-bold" href="index.html">
      <i class="fa-solid fa-ambulance me-2"></i> Emergency Ambulance System
    </a>
    <span class="text-white small">108 Workflow Simulation (Single Unit)</span>
  </div>
</nav>

<div class="container py-5">

<!-- STATUS PANEL -->
<div class="status-box mb-4" id="statusBox">
  <h5 class="fw-bold mb-2">ðŸš‘ Live Ambulance Status</h5>
  <p class="mb-1"><strong>Ambulance ID:</strong> <span id="ambId">AP-31-AX-108</span></p>
  <p class="mb-1"><strong>Current Status:</strong> <span id="ambStatus">IDLE</span></p>
  <p class="mb-0 small text-muted">
    Status updates are managed through a finite-state workflow and persisted locally.
  </p>
</div>

<!-- REQUEST FORM -->
<div class="card shadow-sm border-0 rounded-4 mb-4">
  <div class="card-body p-4">
    <h4 class="fw-bold mb-3">
      <i class="fa-solid fa-bell me-2"></i> Request Emergency Ambulance
    </h4>

    <div class="row g-3">

      <div class="col-md-6">
        <label class="form-label">Patient Name *</label>
        <input type="text" class="form-control" id="patientName">
      </div>

      <div class="col-md-6">
        <label class="form-label">Emergency Type *</label>
        <select class="form-select" id="emergencyType">
          <option value="">Select</option>
          <option>Road Traffic Accident</option>
          <option>Cardiac Emergency</option>
          <option>Pregnancy Complication</option>
          <option>Snake Bite</option>
          <option>Unconscious Patient</option>
        </select>
      </div>

      <div class="col-12">
        <label class="form-label">Brief Description *</label>
        <textarea class="form-control" id="description" rows="3"></textarea>
      </div>

      <div class="col-md-6">
        <label class="form-label">Latitude *</label>
        <input type="text" class="form-control readonly" id="lat" readonly>
      </div>

      <div class="col-md-6">
        <label class="form-label">Longitude *</label>
        <input type="text" class="form-control readonly" id="lng" readonly>
      </div>

      <div class="col-12 d-flex gap-2">
        <button class="btn btn-outline-secondary" onclick="getLocation()">
          <i class="fa-solid fa-location-crosshairs me-1"></i> Capture Location
        </button>
        <button class="btn btn-danger fw-bold" id="dispatchBtn" onclick="requestAmbulance()" disabled>
          <i class="fa-solid fa-truck-medical me-1"></i> Dispatch Ambulance
        </button>
      </div>

    </div>
  </div>
</div>

<!-- LAST REQUEST -->
<div class="card shadow-sm border-0 rounded-4">
  <div class="card-body p-4">
    <h5 class="fw-bold mb-2">ðŸ“‹ Last Emergency Request</h5>
    <pre class="bg-dark text-white p-3 rounded small" id="lastRequest">No active requests</pre>
  </div>
</div>

</div>

<script>
/* =========================
   CORE AMBULANCE ENGINE
========================= */

const STORAGE_KEY = "RHC_AMBULANCE_STATE";

let ambulanceState = {
  status: "IDLE",
  patientName: "",
  emergencyType: "",
  description: "",
  location: null,
  timestamps: {}
};

/* ---------- LOAD STATE ---------- */
function loadState() {
  const saved = localStorage.getItem(STORAGE_KEY);
  if (saved) {
    ambulanceState = JSON.parse(saved);
    updateUI();
  }
}
loadState();

/* ---------- SAVE STATE ---------- */
function saveState() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(ambulanceState));
}

/* ---------- UI UPDATE ---------- */
function updateUI() {
  const statusEl = document.getElementById("ambStatus");
  const box = document.getElementById("statusBox");

  statusEl.innerText = ambulanceState.status;
  box.className = "status-box mb-4 status-" + ambulanceState.status.toLowerCase();

  document.getElementById("lastRequest").innerText =
    ambulanceState.patientName
      ? JSON.stringify(ambulanceState, null, 2)
      : "No active requests";
}

/* ---------- VALIDATION ---------- */
function validateForm() {
  const valid =
    patientName.value.trim() &&
    emergencyType.value &&
    description.value.trim() &&
    lat.value && lng.value &&
    ambulanceState.status === "IDLE";

  dispatchBtn.disabled = !valid;
}

/* ---------- LOCATION ---------- */
function getLocation() {
  navigator.geolocation.getCurrentPosition(pos => {
    lat.value = pos.coords.latitude.toFixed(6);
    lng.value = pos.coords.longitude.toFixed(6);
    validateForm();
  }, () => {
    alert("Location access required for dispatch.");
  });
}

/* ---------- REQUEST ---------- */
function requestAmbulance() {
  ambulanceState = {
    status: "REQUEST_ACCEPTED",
    patientName: patientName.value,
    emergencyType: emergencyType.value,
    description: description.value,
    location: { lat: lat.value, lng: lng.value },
    timestamps: { requested: new Date().toISOString() }
  };
  saveState();
  updateUI();
  runWorkflow();
}

/* ---------- WORKFLOW ---------- */
function runWorkflow() {
  setTimeout(() => transition("DISPATCHED"), 4000);
  setTimeout(() => transition("EN_ROUTE"), 9000);
  setTimeout(() => transition("ARRIVED"), 16000);
}

function transition(newStatus) {
  ambulanceState.status = newStatus;
  ambulanceState.timestamps[newStatus.toLowerCase()] = new Date().toISOString();
  saveState();
  updateUI();
}

/* ---------- EVENT BINDINGS ---------- */
["patientName","emergencyType","description"].forEach(id => {
  document.getElementById(id).addEventListener("input", validateForm);
});

updateUI();
</script>

</body>
</html>
