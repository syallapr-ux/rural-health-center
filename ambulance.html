<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Emergency Ambulance Dispatch</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f6f8;
      padding: 20px;
    }
    h1 {
      color: #c62828;
    }
    .card {
      background: #fff;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    label {
      display: block;
      margin-top: 10px;
      font-weight: bold;
    }
    input, textarea, select {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
    }
    button {
      margin-top: 15px;
      padding: 10px 15px;
      cursor: pointer;
    }
    .danger { background: #c62828; color: white; }
    .info { background: #1565c0; color: white; }
    .success { background: #2e7d32; color: white; }
    .disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .status {
      font-size: 18px;
      font-weight: bold;
    }
    .log {
      background: #eee;
      padding: 10px;
      max-height: 200px;
      overflow-y: auto;
      font-size: 14px;
    }
  </style>
</head>
<body>

<h1>ðŸš‘ Integrated Emergency Ambulance Dispatch</h1>

<div class="card">
  <h3>Emergency Request</h3>

  <label>Patient Name</label>
  <input id="patientName" />

  <label>Emergency Type</label>
  <select id="emergencyType">
    <option value="">Select</option>
    <option>Road Traffic Accident</option>
    <option>Cardiac Emergency</option>
    <option>Trauma</option>
    <option>Pregnancy Emergency</option>
  </select>

  <label>Description</label>
  <textarea id="description"></textarea>

  <label>Caller Location</label>
  <input id="location" readonly placeholder="Click Get Location" />
  <button onclick="LocationService.getLocation()">Get Location</button>

  <button class="danger" onclick="UIActions.requestAmbulance()">Request Ambulance</button>
</div>

<div class="card">
  <h3>Ambulance Status</h3>
  <p class="status" id="statusText">IDLE</p>

  <button class="info" onclick="UIActions.dispatch()">Dispatch</button>
  <button class="info" onclick="UIActions.markEnRoute()">Mark En Route</button>
  <button class="success" onclick="UIActions.markArrived()">Mark Arrived</button>
  <button onclick="UIActions.reset()">Reset</button>
</div>

<div class="card">
  <h3>System Log</h3>
  <div class="log" id="logBox"></div>
</div>

<script>
/* ================================
   STATE MACHINE
================================ */
const STATUS_FLOW = {
  IDLE: ["REQUEST_ACCEPTED"],
  REQUEST_ACCEPTED: ["DISPATCHED"],
  DISPATCHED: ["EN_ROUTE"],
  EN_ROUTE: ["ARRIVED"],
  ARRIVED: []
};

/* ================================
   STORAGE SERVICE
================================ */
const STORAGE_KEY = "AMBULANCE_STATE";

const StorageService = {
  save(data) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  },
  load() {
    return JSON.parse(localStorage.getItem(STORAGE_KEY));
  },
  clear() {
    localStorage.removeItem(STORAGE_KEY);
  }
};

/* ================================
   STATE
================================ */
let ambulanceState = StorageService.load() || {
  status: "IDLE",
  request: null,
  timestamps: {}
};

/* ================================
   CORE SERVICE LAYER
================================ */
const AmbulanceService = {

  request(data) {
    if (ambulanceState.status !== "IDLE") {
      throw new Error("Ambulance already busy");
    }

    ambulanceState.request = data;
    this.transition("REQUEST_ACCEPTED");
  },

  transition(newStatus) {
    const allowed = STATUS_FLOW[ambulanceState.status];

    if (!allowed.includes(newStatus)) {
      throw new Error(`Invalid transition from ${ambulanceState.status} to ${newStatus}`);
    }

    ambulanceState.status = newStatus;
    ambulanceState.timestamps[newStatus] = new Date().toISOString();
    StorageService.save(ambulanceState);
    Logger.log(`Status changed â†’ ${newStatus}`);
    UI.update();
  },

  reset() {
    ambulanceState = {
      status: "IDLE",
      request: null,
      timestamps: {}
    };
    StorageService.clear();
    Logger.log("System reset");
    UI.update();
  }
};

/* ================================
   LOCATION SERVICE
================================ */
const LocationService = {
  getLocation() {
    if (!navigator.geolocation) {
      alert("Geolocation not supported");
      return;
    }

    navigator.geolocation.getCurrentPosition(
      pos => {
        document.getElementById("location").value =
          `${pos.coords.latitude}, ${pos.coords.longitude}`;
        Logger.log("Location captured");
      },
      () => alert("Location access denied")
    );
  }
};

/* ================================
   UI ACTIONS
================================ */
const UIActions = {

  requestAmbulance() {
    try {
      const data = {
        patient: patientName.value.trim(),
        type: emergencyType.value,
        description: description.value.trim(),
        location: location.value
      };

      if (!data.patient || !data.type || !data.location) {
        alert("All fields including location are required");
        return;
      }

      AmbulanceService.request(data);
    } catch (e) {
      alert(e.message);
    }
  },

  dispatch() {
    try {
      AmbulanceService.transition("DISPATCHED");
    } catch (e) { alert(e.message); }
  },

  markEnRoute() {
    try {
      AmbulanceService.transition("EN_ROUTE");
    } catch (e) { alert(e.message); }
  },

  markArrived() {
    try {
      AmbulanceService.transition("ARRIVED");
    } catch (e) { alert(e.message); }
  },

  reset() {
    AmbulanceService.reset();
  }
};

/* ================================
   UI RENDERING
================================ */
const UI = {
  update() {
    document.getElementById("statusText").innerText =
      ambulanceState.status;
  }
};

/* ================================
   LOGGER
================================ */
const Logger = {
  log(msg) {
    const box = document.getElementById("logBox");
    box.innerHTML += `[${new Date().toLocaleTimeString()}] ${msg}<br>`;
  }
};

UI.update();
</script>

</body>
</html>
