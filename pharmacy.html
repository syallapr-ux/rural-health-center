<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Government Pharmacy Services</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
body { background:#f8f9fa; }
.badge-available { background:#198754; }
.badge-critical  { background:#dc3545; }
.badge-out       { background:#6c757d; }
.toast-container { z-index:1055; }
</style>
</head>

<body>

<nav class="navbar navbar-dark bg-primary">
<div class="container">
<span class="navbar-brand fw-bold">Integrated Government Pharmacy</span>
</div>
</nav>

<div class="container my-5">

<!-- ERROR MESSAGE -->
<div id="errorMessage" class="alert alert-danger d-none"></div>

<!-- SUMMARY -->
<div class="row g-3 mb-4">
<div class="col-md-6">
<div class="card p-3 shadow-sm">
<h6>Total Medicines Listed</h6>
<h3 id="totalCount" class="fw-bold text-primary"></h3>
</div>
</div>
<div class="col-md-6">
<div class="card p-3 shadow-sm">
<h6>Critical Stock Alerts</h6>
<h3 id="criticalCount" class="fw-bold text-danger"></h3>
</div>
</div>
</div>

<!-- SEARCH -->
<input type="text" id="searchBox" class="form-control mb-4"
placeholder="Search medicines..."
onkeyup="searchMedicine()">

<!-- TABLE -->
<div class="card mb-5 shadow">
<div class="card-header bg-primary text-white">Medicine Inventory</div>
<div class="table-responsive">
<table class="table mb-0" id="medicineTable">
<thead class="table-light">
<tr>
<th>Name</th>
<th>Category</th>
<th>Stock</th>
<th>Usage</th>
<th>Status</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
</div>

<!-- DISPENSE -->
<div class="card shadow">
<div class="card-body">
<h5 class="fw-bold mb-3">Dispense Medicine</h5>

<div class="row g-3">
<div class="col-md-6">
<input type="text" id="abhaId" class="form-control" placeholder="example@abdm">
</div>
<div class="col-md-6">
<input type="text" id="medicineName" class="form-control" placeholder="Paracetamol 500mg">
</div>
</div>

<button class="btn btn-primary mt-4" onclick="dispenseMedicine()">Dispense</button>
</div>
</div>

</div>

<!-- TOAST -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
<div id="successToast" class="toast text-bg-success">
<div class="toast-body">Medicine dispensed successfully.</div>
</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
/* ================= CONFIG ================= */
const CRITICAL_LIMIT = 30;

/* ================= DATA ================= */
let medicines = [
{ name:"Paracetamol 500mg", category:"Analgesic", stock:420, usage:"Fever / Pain" },
{ name:"Amoxicillin", category:"Antibiotic", stock:110, usage:"Infection" },
{ name:"Anti-Snake Venom", category:"Emergency", stock:22, usage:"Snake Bite" }
];

/* ================= LOAD FROM STORAGE ================= */
if (localStorage.getItem("medicines")) {
medicines = JSON.parse(localStorage.getItem("medicines"));
}

/* ================= INIT ================= */
window.onload = () => {
renderTable();
updateSummary();
};

/* ================= UI HELPERS ================= */
function showError(message) {
const div = document.getElementById("errorMessage");
div.textContent = message;
div.classList.remove("d-none");
setTimeout(() => div.classList.add("d-none"), 3000);
}

/* ================= SUMMARY ================= */
function updateSummary() {
document.getElementById("totalCount").innerText = medicines.length;
if (medicines.length === 0) {
document.getElementById("criticalCount").innerText = 0;
return;
}
const critical = medicines.filter(m => m.stock > 0 && m.stock <= CRITICAL_LIMIT).length;
document.getElementById("criticalCount").innerText = critical;
}

/* ================= TABLE ================= */
function renderTable() {
const tbody = document.querySelector("#medicineTable tbody");
tbody.innerHTML = "";

if (medicines.length === 0) {
tbody.innerHTML = `<tr><td colspan="5" class="text-center">No medicines available</td></tr>`;
return;
}

medicines.forEach(m => {
let status="Available", badge="badge-available";
if (m.stock === 0) { status="Out of Stock"; badge="badge-out"; }
else if (m.stock <= CRITICAL_LIMIT) { status="Critical"; badge="badge-critical"; }

tbody.innerHTML += `
<tr>
<td>${m.name}</td>
<td>${m.category}</td>
<td>${m.stock}</td>
<td>${m.usage}</td>
<td><span class="badge ${badge}">${status}</span></td>
</tr>`;
});
}

/* ================= SEARCH ================= */
function searchMedicine() {
const filter = document.getElementById("searchBox").value.toLowerCase();
let visibleCritical = 0;

document.querySelectorAll("#medicineTable tbody tr").forEach(row => {
const visible = row.innerText.toLowerCase().includes(filter);
row.style.display = visible ? "" : "none";

if (visible && row.children.length) {
const stock = parseInt(row.children[2].innerText);
if (stock > 0 && stock <= CRITICAL_LIMIT) visibleCritical++;
}
});

document.getElementById("criticalCount").innerText = visibleCritical;
}

/* ================= VALIDATION ================= */
function validABHA(abha) {
const regex = /^[a-zA-Z0-9._-]+@abdm$/;
if (!regex.test(abha)) {
showError("Invalid ABHA ID format. Use example@abdm");
return false;
}
return true;
}

/* ================= DISPENSE ================= */
function dispenseMedicine() {
const abha = document.getElementById("abhaId").value.trim();
const medName = document.getElementById("medicineName").value.trim();

if (!validABHA(abha)) return;

const med = medicines.find(m => m.name.toLowerCase() === medName.toLowerCase());
if (!med) { showError("Medicine not found."); return; }

if (med.stock <= 0) { showError("Medicine is out of stock."); return; }

med.stock--;

if (med.stock <= CRITICAL_LIMIT && med.stock > 0) {
showError("Warning: Stock is critical for " + med.name);
}

localStorage.setItem("medicines", JSON.stringify(medicines));
renderTable();
updateSummary();

new bootstrap.Toast(document.getElementById("successToast")).show();
}
</script>

</body>
</html>
