<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Integrated Government Pharmacy | Home Delivery</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body { background: #f8f9fa; }
        .badge-available { background-color: #198754; cursor: pointer; }
        .badge-critical { background-color: #dc3545; cursor: pointer; }
        .badge-out { background-color: #6c757d; cursor: pointer; }
        .toast-container { z-index: 1055; }
        .stock-critical { color: #dc3545; font-weight: bold; }
    </style>
</head>

<body>

<!-- NAVBAR -->
<nav class="navbar navbar-dark bg-primary shadow">
    <div class="container">
        <span class="navbar-brand fw-bold">
            Integrated Government Pharmacy System
        </span>
    </div>
</nav>

<div class="container my-5">

    <!-- ERROR MESSAGE -->
    <div id="errorMessage" class="alert alert-danger d-none" role="alert"></div>

    <!-- SUMMARY -->
    <div class="row g-3 mb-4">
        <div class="col-md-6">
            <div class="card p-3 shadow-sm">
                <h6>Total Medicines Listed</h6>
                <h3 id="totalCount" class="fw-bold text-primary"></h3>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card p-3 shadow-sm">
                <h6>Critical Stock Alerts</h6>
                <h3 id="criticalCount" class="fw-bold text-danger"></h3>
            </div>
        </div>
    </div>

    <!-- SEARCH -->
    <input type="text" id="searchBox" class="form-control mb-4"
           placeholder="Search by name, category, or usage"
           aria-label="Search medicines"
           onkeyup="searchMedicine()">

    <!-- INVENTORY TABLE -->
    <div class="card mb-5 shadow">
        <div class="card-header bg-primary text-white fw-bold">
            Medicine Inventory
        </div>
        <div class="table-responsive">
            <table class="table mb-0" id="medicineTable" aria-live="polite">
                <thead class="table-light">
                    <tr>
                        <th>Name</th>
                        <th>Category</th>
                        <th>Stock</th>
                        <th>Usage</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <!-- HOME DELIVERY -->
    <div class="card shadow mb-5">
        <div class="card-body">
            <h5 class="fw-bold mb-3">Request Medicine Home Delivery</h5>

            <div class="row g-3">
                <div class="col-md-6">
                    <input type="text" id="abhaId" class="form-control"
                           placeholder="example@abdm"
                           aria-label="ABHA ID">
                </div>
                <div class="col-md-6">
                    <input type="text" id="medicineName" class="form-control"
                           placeholder="Paracetamol 500mg"
                           aria-label="Medicine name">
                </div>
                <div class="col-md-12">
                    <input type="text" id="deliveryAddress" class="form-control"
                           placeholder="Full delivery address with area & pincode"
                           aria-label="Delivery address">
                </div>
            </div>

            <button class="btn btn-primary mt-4" onclick="requestHomeDelivery()">
                Request Home Delivery
            </button>
        </div>
    </div>

    <!-- DELIVERY HISTORY -->
    <div class="card shadow">
        <div class="card-header bg-dark text-white fw-bold">
            Delivery History
        </div>
        <div class="card-body">
            <ul id="deliveryHistory" class="list-group small"></ul>
        </div>
    </div>
</div>

<!-- TOASTS -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="successToast" class="toast text-bg-success mb-2">
        <div class="toast-body">Medicine dispatched successfully.</div>
    </div>
    <div id="errorToast" class="toast text-bg-danger">
        <div class="toast-body">Action failed. Please check details.</div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
/* ================= CONFIG ================= */
const CRITICAL_LIMIT = 30;

/* ================= DATA ================= */
// Inventory persistence using localStorage (mock database)
let medicines = JSON.parse(localStorage.getItem("medicines")) || [
    { name: "Paracetamol 500mg", category: "Analgesic", stock: 420, usage: "Fever / Pain" },
    { name: "Amoxicillin", category: "Antibiotic", stock: 110, usage: "Infection" },
    { name: "Anti-Snake Venom", category: "Emergency", stock: 22, usage: "Snake Bite" },
    { name: "ORS Packets", category: "Essential", stock: 980, usage: "Dehydration" },
    { name: "Insulin", category: "Emergency", stock: 50, usage: "Diabetes" }
];

let deliveries = JSON.parse(localStorage.getItem("deliveries")) || [];

/* ================= INIT ================= */
window.onload = () => {
    renderTable();
    updateSummary();
    renderDeliveryHistory();
};

/* ================= SUMMARY ================= */
function updateSummary() {
    document.getElementById("totalCount").innerText = medicines.length;
    document.getElementById("criticalCount").innerText =
        medicines.filter(m => m.stock > 0 && m.stock <= CRITICAL_LIMIT).length;
}

/* ================= TABLE ================= */
function renderTable() {
    const tbody = document.querySelector("#medicineTable tbody");
    tbody.innerHTML = "";

    if (medicines.length === 0) {
        tbody.innerHTML = `<tr><td colspan="5" class="text-center">No medicines available</td></tr>`;
        return;
    }

    medicines.forEach(m => {
        let status = "Available", badge = "badge-available", stockClass = "";
        if (m.stock === 0) { status = "Out of Stock"; badge = "badge-out"; }
        else if (m.stock <= CRITICAL_LIMIT) {
            status = "Critical"; badge = "badge-critical"; stockClass = "stock-critical";
        }

        tbody.innerHTML += `
        <tr>
            <td>${m.name}</td>
            <td>${m.category}</td>
            <td class="${stockClass}">${m.stock}</td>
            <td>${m.usage}</td>
            <td><span class="badge ${badge}">${status}</span></td>
        </tr>`;
    });
}

/* ================= SEARCH ================= */
function searchMedicine() {
    const filter = searchBox.value.toLowerCase();
    document.querySelectorAll("#medicineTable tbody tr").forEach(row => {
        row.style.display = row.innerText.toLowerCase().includes(filter) ? "" : "none";
    });
}

/* ================= VALIDATION ================= */
function validABHA(abha) {
    if (!abha || abha.includes(" ")) {
        showError("ABHA ID cannot contain spaces.");
        return false;
    }
    if (!/^[a-zA-Z0-9._-]+@abdm$/.test(abha)) {
        showError("ABHA ID must follow example@abdm format.");
        return false;
    }
    return true;
}

/* ================= HOME DELIVERY ================= */
function requestHomeDelivery() {
    const abha = abhaId.value.trim();
    const medName = medicineName.value.trim();
    const address = deliveryAddress.value.trim();

    if (!validABHA(abha)) return;
    if (!medName) return showError("Medicine name is required.");
    if (!address || address.length < 10)
        return showError("Delivery address must be at least 10 characters.");

    const med = medicines.find(m => m.name.toLowerCase() === medName.toLowerCase());
    if (!med) return showError("Medicine not found.");
    if (med.stock <= 0) return showError("Medicine is out of stock.");

    med.stock--;

    deliveries.push({
        abha,
        medicine: med.name,
        address,
        time: new Date().toLocaleString(),
        status: "Dispatched"
    });

    localStorage.setItem("medicines", JSON.stringify(medicines));
    localStorage.setItem("deliveries", JSON.stringify(deliveries));

    renderTable();
    updateSummary();
    renderDeliveryHistory();

    new bootstrap.Toast(successToast).show();
}

/* ================= DELIVERY HISTORY ================= */
function renderDeliveryHistory() {
    const list = document.getElementById("deliveryHistory");
    list.innerHTML = deliveries.length === 0
        ? "<li class='list-group-item text-muted'>No deliveries yet</li>"
        : deliveries.map(d =>
            `<li class="list-group-item">
                <strong>${d.medicine}</strong> â†’ ${d.address}<br>
                <small>${d.time} | ${d.status}</small>
            </li>`
        ).join("");
}

/* ================= ERROR ================= */
function showError(msg) {
    const div = document.getElementById("errorMessage");
    div.textContent = msg;
    div.classList.remove("d-none");
    new bootstrap.Toast(errorToast).show();
    setTimeout(() => div.classList.add("d-none"), 3000);
}
</script>

</body>
</html>
