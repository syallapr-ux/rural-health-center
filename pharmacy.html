<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Integrated Government Pharmacy System</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body { background-color: #f4f6f8; }

        .badge-available { background-color: #198754; }
        .badge-critical { background-color: #dc3545; }
        .badge-out { background-color: #6c757d; }

        .row-critical { background-color: #fff1f1; }
        .row-out { background-color: #f2f2f2; }

        .stock-critical { color: #dc3545; font-weight: bold; }

        .is-invalid { border-color: #dc3545; }

        .fixed-alert {
            position: fixed;
            top: 56px;
            left: 0;
            right: 0;
            z-index: 1050;
        }
    </style>
</head>

<body>

<!-- ================= NAVBAR ================= -->
<nav class="navbar navbar-dark bg-primary fixed-top shadow">
    <div class="container">
        <span class="navbar-brand fw-bold">Integrated Government Pharmacy</span>
    </div>
</nav>

<!-- ================= ERROR ALERT ================= -->
<div id="errorBox" class="alert alert-danger d-none fixed-alert text-center"></div>

<div class="container mt-5 pt-4">

    <!-- ================= SUMMARY ================= -->
    <div class="row g-3 mb-4">
        <div class="col-md-6">
            <div class="card p-3 shadow-sm">
                <h6>Total Medicines</h6>
                <h3 id="totalMedicines" class="fw-bold text-primary"></h3>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card p-3 shadow-sm">
                <h6>Critical Stock Alerts</h6>
                <h3 id="criticalMedicines" class="fw-bold text-danger"></h3>
            </div>
        </div>
    </div>

    <!-- ================= SEARCH ================= -->
    <input type="text" id="searchBox" class="form-control mb-4"
           placeholder="Search medicines..." onkeyup="searchMedicines()">

    <!-- ================= INVENTORY TABLE ================= -->
    <div class="card shadow mb-5">
        <div class="card-header bg-primary text-white fw-bold">
            Medicine Inventory
        </div>
        <div class="table-responsive">
            <table class="table mb-0">
                <thead class="table-light">
                <tr>
                    <th>Name</th>
                    <th>Category</th>
                    <th>Stock</th>
                    <th>Usage</th>
                    <th>Status</th>
                </tr>
                </thead>
                <tbody id="medicineTable"></tbody>
            </table>
        </div>
    </div>

    <!-- ================= DELIVERY REQUEST ================= -->
    <div class="card shadow mb-5">
        <div class="card-body">
            <h5 class="fw-bold mb-3">Request Home Delivery</h5>

            <div class="row g-3">
                <div class="col-md-6">
                    <input type="text" id="abhaId" class="form-control" placeholder="example@abdm">
                </div>
                <div class="col-md-6">
                    <input type="text" id="medicineName" class="form-control" placeholder="Medicine Name">
                </div>
                <div class="col-md-12">
                    <input type="text" id="deliveryAddress" class="form-control"
                           placeholder="House no, Street, City, Pincode">
                </div>
            </div>

            <button class="btn btn-primary mt-4" onclick="confirmDelivery()">
                Request Delivery
            </button>
        </div>
    </div>

    <!-- ================= DELIVERY HISTORY ================= -->
    <div class="card shadow">
        <div class="card-header bg-dark text-white fw-bold d-flex justify-content-between">
            Delivery History
            <select id="statusFilter" class="form-select form-select-sm w-auto"
                    onchange="renderDeliveryHistory()">
                <option value="all">All</option>
                <option value="Dispatched">Dispatched</option>
                <option value="Delivered">Delivered</option>
            </select>
        </div>
        <ul id="deliveryHistory" class="list-group list-group-flush"></ul>
    </div>

</div>

<script>
/* ============================================================
   CONFIG & DATA (localStorage = mock backend)
   NOTE: Not suitable for concurrent users or sensitive data
   ============================================================ */
const CRITICAL_LIMIT = 30;

let medicines = JSON.parse(localStorage.getItem("medicines")) || [
    { name: "Paracetamol 500mg", category: "Analgesic", stock: 50, usage: "Fever / Pain" },
    { name: "Amoxicillin", category: "Antibiotic", stock: 25, usage: "Infection" },
    { name: "Insulin", category: "Emergency", stock: 15, usage: "Diabetes" }
];

let deliveries = JSON.parse(localStorage.getItem("deliveries")) || [];

/* ============================================================
   INITIALIZATION
   ============================================================ */
window.onload = () => {
    renderMedicines();
    updateSummary();
    renderDeliveryHistory();
};

/* ============================================================
   RENDERING
   ============================================================ */
function renderMedicines() {
    const table = document.getElementById("medicineTable");
    table.innerHTML = "";

    medicines.forEach(m => {
        let status = "Available", badge = "badge-available", rowClass = "";
        if (m.stock === 0) {
            status = "Out of Stock";
            badge = "badge-out";
            rowClass = "row-out";
        } else if (m.stock <= CRITICAL_LIMIT) {
            status = "Critical";
            badge = "badge-critical";
            rowClass = "row-critical";
        }

        table.innerHTML += `
        <tr class="${rowClass}">
            <td>${m.name}</td>
            <td>${m.category}</td>
            <td class="${m.stock <= CRITICAL_LIMIT ? 'stock-critical' : ''}">${m.stock}</td>
            <td>${m.usage}</td>
            <td><span class="badge ${badge}">${status}</span></td>
        </tr>`;
    });
}

function updateSummary() {
    totalMedicines.innerText = medicines.length;
    criticalMedicines.innerText =
        medicines.filter(m => m.stock > 0 && m.stock <= CRITICAL_LIMIT).length;
}

/* ============================================================
   SEARCH
   ============================================================ */
function searchMedicines() {
    const value = searchBox.value.toLowerCase();
    document.querySelectorAll("#medicineTable tr").forEach(row => {
        row.style.display = row.innerText.toLowerCase().includes(value) ? "" : "none";
    });
}

/* ============================================================
   VALIDATION
   ============================================================ */
function showError(msg, fields = []) {
    errorBox.innerText = msg;
    errorBox.classList.remove("d-none");

    fields.forEach(id => document.getElementById(id).classList.add("is-invalid"));

    setTimeout(() => {
        errorBox.classList.add("d-none");
        fields.forEach(id => document.getElementById(id).classList.remove("is-invalid"));
    }, 3000);
}

/* ============================================================
   DELIVERY WORKFLOW
   ============================================================ */
function confirmDelivery() {
    if (!confirm("Confirm delivery request? Stock will be reduced.")) return;
    requestDelivery();
}

function requestDelivery() {
    const abha = abhaId.value.trim();
    const medName = medicineName.value.trim();
    const address = deliveryAddress.value.trim();

    if (!/^[a-zA-Z0-9._-]+@abdm$/.test(abha))
        return showError("Invalid ABHA ID format.", ["abhaId"]);

    if (address.length < 10 || !/\d/.test(address))
        return showError("Invalid delivery address.", ["deliveryAddress"]);

    const med = medicines.find(m => m.name.toLowerCase() === medName.toLowerCase());
    if (!med) return showError("Medicine not found.", ["medicineName"]);
    if (med.stock === 0) return showError("Medicine is out of stock.");

    med.stock--;

    deliveries.push({
        medicine: med.name,
        address,
        time: new Date().toLocaleString(),
        status: "Dispatched"
    });

    localStorage.setItem("medicines", JSON.stringify(medicines));
    localStorage.setItem("deliveries", JSON.stringify(deliveries));

    renderMedicines();
    updateSummary();
    renderDeliveryHistory();
}

/* ============================================================
   DELIVERY HISTORY
   ============================================================ */
function renderDeliveryHistory() {
    const filter = statusFilter.value;
    const list = deliveryHistory;
    list.innerHTML = "";

    deliveries
        .filter(d => filter === "all" || d.status === filter)
        .forEach(d => {
            list.innerHTML += `
            <li class="list-group-item">
                <strong>${d.medicine}</strong><br>
                ${d.address}<br>
                <small>${d.time} | ${d.status}</small>
            </li>`;
        });

    if (list.innerHTML === "")
        list.innerHTML = `<li class="list-group-item text-muted">No deliveries</li>`;
}
</script>

</body>
</html>
