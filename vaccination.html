<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Vaccination Management System | Rural Health Connect</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
body { background:#f4f6f8; }
.card { border-radius:8px; }
.status { font-weight:bold; }
.log { background:#f1f1f1; max-height:200px; overflow:auto; padding:10px; font-size:13px; }
button:disabled { opacity:0.6; cursor:not-allowed; }
</style>
</head>

<body>

<nav class="navbar navbar-dark bg-success">
  <div class="container">
    <span class="navbar-brand fw-bold">National Immunization Management System</span>
  </div>
</nav>

<main class="container my-4">

<!-- DASHBOARD -->
<section class="row g-3 mb-4">
  <div class="col-md-4"><div class="card p-3 shadow-sm"><div>Beneficiaries</div><h4 id="statBeneficiaries">0</h4></div></div>
  <div class="col-md-4"><div class="card p-3 shadow-sm"><div>Scheduled Appointments</div><h4 id="statAppointments">0</h4></div></div>
  <div class="col-md-4"><div class="card p-3 shadow-sm"><div>Completed Vaccinations</div><h4 id="statCompleted">0</h4></div></div>
</section>

<!-- BENEFICIARY -->
<section class="card p-4 shadow mb-4">
<h5 class="fw-bold">Register Beneficiary</h5>
<div class="row g-3">
  <div class="col-md-3"><input class="form-control" id="bName" placeholder="Name"></div>
  <div class="col-md-2"><input type="number" class="form-control" id="bAge" placeholder="Age"></div>
  <div class="col-md-3">
    <select class="form-select" id="bCategory">
      <option value="">Category</option>
      <option>Child</option>
      <option>Pregnant Woman</option>
      <option>Adult</option>
      <option>Senior Citizen</option>
    </select>
  </div>
  <div class="col-md-4"><input class="form-control" id="bAbha" placeholder="ABHA / Aadhaar"></div>
</div>
<button class="btn btn-success mt-3" onclick="UI.registerBeneficiary()">Register & Set Active</button>
</section>

<!-- ELIGIBILITY -->
<section class="card p-4 shadow mb-4">
<h5 class="fw-bold">Eligibility Engine</h5>
<button class="btn btn-primary" onclick="UI.checkEligibility()">Check Eligibility</button>
<div id="eligibilityResult" class="alert alert-info mt-3 d-none"></div>
</section>

<!-- APPOINTMENT -->
<section class="card p-4 shadow mb-4">
<h5 class="fw-bold">Schedule Appointment</h5>
<div class="row g-3">
  <div class="col-md-6"><input class="form-control" id="vaccineName" placeholder="Vaccine"></div>
  <div class="col-md-6"><input type="date" class="form-control" id="apptDate"></div>
</div>
<button class="btn btn-warning mt-3" onclick="UI.scheduleAppointment()">Schedule Appointment</button>
</section>

<!-- WORKFLOW -->
<section class="card p-4 shadow mb-4">
<h5 class="fw-bold">Vaccination Workflow</h5>
<button class="btn btn-success me-2" id="completeBtn" onclick="UI.complete()" disabled>Mark Completed</button>
<button class="btn btn-danger" id="missBtn" onclick="UI.miss()" disabled>Mark Missed</button>
<p class="mt-3">Current Status: <span class="status" id="apptStatus">N/A</span></p>
</section>

<!-- LOG -->
<section class="card p-4 shadow">
<h5 class="fw-bold">Audit Log</h5>
<div class="log" id="logBox"></div>
</section>

</main>

<script>
/* ================= STORAGE ================= */
const StorageService = {
  save(state) { localStorage.setItem("VACCINE_STATE", JSON.stringify(state)); },
  load() { return JSON.parse(localStorage.getItem("VACCINE_STATE")); }
};

/* ================= STATE ================= */
let vaccinationState = StorageService.load() || {
  beneficiaries: [],
  appointments: [],
  vaccinationRecords: []
};

let activeBeneficiaryId = null;
let activeAppointmentId = null;

/* ================= RULES ================= */
const ELIGIBILITY_RULES = [
  { condition: b => b.age < 5, vaccines:["BCG","OPV","HepB"] },
  { condition: b => b.category === "Pregnant Woman", vaccines:["TT/Td"] },
  { condition: b => b.age >= 18, vaccines:["COVID Booster"] }
];

const APPOINTMENT_FLOW = {
  SCHEDULED:["COMPLETED","MISSED"],
  COMPLETED:[],
  MISSED:[]
};

/* ================= SERVICES ================= */
const VaccinationService = {

  registerBeneficiary(data){
    if(!data.name || !data.age || !data.category) throw "Invalid beneficiary data";
    const b = { id:Date.now(), ...data };
    vaccinationState.beneficiaries.push(b);
    activeBeneficiaryId = b.id;
    Logger.log("Beneficiary registered");
    StorageService.save(vaccinationState);
  },

  checkEligibility(){
    if(!activeBeneficiaryId) throw "No active beneficiary";
    const b = vaccinationState.beneficiaries.find(x=>x.id===activeBeneficiaryId);
    return ELIGIBILITY_RULES.filter(r=>r.condition(b)).flatMap(r=>r.vaccines);
  },

  scheduleAppointment(vaccine,date){
    if(!activeBeneficiaryId) throw "No active beneficiary";
    if(!vaccine || !date) throw "Invalid appointment data";
    const a = { id:Date.now(), beneficiaryId:activeBeneficiaryId, vaccine, date, status:"SCHEDULED" };
    vaccinationState.appointments.push(a);
    activeAppointmentId = a.id;
    Logger.log("Appointment scheduled");
    StorageService.save(vaccinationState);
  },

  transition(status){
    if(!activeAppointmentId) throw "No active appointment";
    const a = vaccinationState.appointments.find(x=>x.id===activeAppointmentId);
    if(!APPOINTMENT_FLOW[a.status].includes(status)) throw "Invalid transition";
    a.status=status;
    if(status==="COMPLETED"){
      vaccinationState.vaccinationRecords.push({ beneficiaryId:a.beneficiaryId, vaccine:a.vaccine, date:new Date().toISOString() });
      Logger.log("Vaccination completed");
    }
    StorageService.save(vaccinationState);
  },

  stats(){
    return {
      beneficiaries:vaccinationState.beneficiaries.length,
      appointments:vaccinationState.appointments.filter(a=>a.status==="SCHEDULED").length,
      completed:vaccinationState.vaccinationRecords.length
    };
  }
};

/* ================= UI ================= */
const UI = {

  registerBeneficiary(){
    VaccinationService.registerBeneficiary({
      name:bName.value, age:+bAge.value, category:bCategory.value, abhaId:bAbha.value
    });
    this.update();
  },

  checkEligibility(){
    const v = VaccinationService.checkEligibility();
    eligibilityResult.innerText="Eligible Vaccines: "+v.join(", ");
    eligibilityResult.classList.remove("d-none");
  },

  scheduleAppointment(){
    VaccinationService.scheduleAppointment(vaccineName.value, apptDate.value);
    this.update();
  },

  complete(){ VaccinationService.transition("COMPLETED"); this.update(); },
  miss(){ VaccinationService.transition("MISSED"); this.update(); },

  update(){
    const s = VaccinationService.stats();
    statBeneficiaries.innerText=s.beneficiaries;
    statAppointments.innerText=s.appointments;
    statCompleted.innerText=s.completed;

    const a=vaccinationState.appointments.find(x=>x.id===activeAppointmentId);
    apptStatus.innerText=a?a.status:"N/A";

    completeBtn.disabled=!a||a.status!=="SCHEDULED";
    missBtn.disabled=!a||a.status!=="SCHEDULED";
  }
};

/* ================= LOGGER ================= */
const Logger={ log:m=>logBox.innerHTML+=`[${new Date().toLocaleTimeString()}] ${m}<br>` };

UI.update();
</script>

</body>
</html>
